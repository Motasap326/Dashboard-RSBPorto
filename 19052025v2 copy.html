<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saídas - RSB Porto</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
            text-align: center;
        }

        .container {
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            background-color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 {
            font-size: 24px;
            /* Tamanho do título reduzido */
        }

        .time-info,
        .weather-info {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 30px;
            color: #333;
            width: 100%;
            text-align: center;
        }

        .iframe-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 8px;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 8px;
            font-size: 30px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
        
        td:nth-child(2), td:nth-child(3) {
            text-align: center;
        }

        @media (max-width: 768px) {
            .iframe-container {
                height: 70vh;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Saídas - RSB Porto</h1>

        <!-- Tempo Atual -->
        <div class="time-info">
            <strong>Data/Hora (Porto):</strong> <span id="current-time"></span>
        </div>

        <!-- Previsão do Tempo -->
        <div class="weather-info">
            <strong>Clima Atual no Porto:</strong> <span id="weather-info">Carregando...</span>
        </div>

        <!-- Dados da Planilha -->
        <div class="iframe-container">
            <table>
                <thead>
                    <tr>
                        <th>Morada</th>
                        <th>Serviço</th>
                        <th>Código</th>
                    </tr>
                </thead>
                <tbody id="sheet-data">
                    <tr>
                        <td colspan="3">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Avarias -->
        <div id="dynamic-value">Avarias: Carregando...</div>
    </div>
    <div id="update-status" style="position: fixed; bottom: 10px; right: 10px; background: #2ecc71; color: white; padding: 8px 15px; border-radius: 5px; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px;">
        <span style="display: inline-block; width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse 2s infinite;"></span>
        Última atualização: <span id="last-update" style="font-weight: bold;"></span>
    </div>

    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>

    <script>
        // Função para atualizar a data e hora em Porto
        function updateDateTime() {
            const now = new Date();
            const portoTime = now.toLocaleString('pt-PT', { 
                timeZone: 'Europe/Lisbon',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('current-time').textContent = portoTime;
        }

        // Atualizar a cada segundo (1 segundo)
        setInterval(updateDateTime, 1000);
        updateDateTime(); // Inicializa imediatamente

        // Função para buscar dados da API de clima
        async function fetchWeather() {
            const apiKey = '28f254cbcfd9559338dfd29d793d66f1'; // Sua chave de API
            const city = 'Porto,PT';  // Cidade Porto, Portugal
            const units = 'metric'; // Unidades em Celsius

            const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=${units}`;
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.main) {
                    const temperature = data.main.temp;
                    const description = data.weather[0].description;
                    const weatherInfo = `Temperatura: ${temperature}°C | Condição: ${description}`;
                    document.getElementById('weather-info').textContent = weatherInfo;
                }
            } catch (error) {
                console.error('Erro ao obter os dados do clima', error);
                document.getElementById('weather-info').textContent = 'Erro ao carregar clima';
            }
        }

        // Chamar a função de clima na primeira execução
        fetchWeather();

        // Atualizar o clima a cada 10 minutos (600000 ms)
        setInterval(fetchWeather, 600000); // 10 minutos

        // Função para buscar dados da planilha do Google Sheets via API
        async function fetchSheetData() {
            const sheetId = '1pyEiDyOdNIQ3rdv-4M_WL3kIU0DMVgc2INu16M9ggA4'; // ID da planilha
            const range = 'teste!A1:D31'; // Intervalo de células para buscar, você pode ajustar conforme necessário

            const apiKey = 'AIzaSyDZMue9y-_p6h4v9h0x3lVfIyZk0W2oLsY'; // Substitua por sua chave de API

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.values && data.values.length) {
                    const rows = data.values;
                    const tableBody = document.getElementById('sheet-data');
                    tableBody.innerHTML = '';

                    // Mostrar apenas as linhas 3, 11 e 19
                    const rowsToShow = [3, 11, 19];
                    const headquarters = "Quartel dos Bombeiros Sapadores do Porto";
                    rowsToShow.forEach(rowIndex => {
                        if (rows[rowIndex]) {
                            const row = rows[rowIndex];
                            const address = row[0];
                            const encodedOrigin = encodeURIComponent(headquarters);
                            const encodedDest = encodeURIComponent(address + ", Porto, Portugal");
                            const mapsUrl = `https://www.google.com/maps/dir/${encodedOrigin}/${encodedDest}`;

                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td><a href="${mapsUrl}" target="_blank" style="color: #0066cc; text-decoration: underline;">${address}</a></td><td>${row[2]}</td><td>${row[3]}</td>`;
                            tableBody.appendChild(tr);
                        }
                    });

                    // Atualizar o valor dinâmico de B27
                    const dynamicValue = rows[26] ? rows[26][1] : 'N/A';
                    document.getElementById('dynamic-value').textContent = `Avarias: ${dynamicValue}`;
                }
            } catch (error) {
                console.error('Erro ao obter os dados da planilha', error);
                document.getElementById('sheet-data').innerHTML = '<tr><td colspan="3">Erro ao carregar dados da planilha. Tentando novamente em 10 segundos...</td></tr>';
                // Try again after 10 seconds
                setTimeout(fetchSheetData, 10000);
            }
            // Atualiza o tempo da última atualização
            updateLastUpdateTime();
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('pt-PT', {
                timeZone: 'Europe/Lisbon',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('last-update').textContent = time;
        }

        // Atualizar dados da planilha a cada 10 segundos (10000 ms)
        setInterval(fetchSheetData, 10000); // 10 segundos
        fetchSheetData(); // Executa a primeira vez imediatamente
    </script>

</body>

</html>